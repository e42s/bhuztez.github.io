<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>如何实现Prolog解释器</title>
<link rel="canonical" href="https://bhuztez.github.io/2014/how-to-write-a-prolog-interpreter.html" />
<link rel="stylesheet" href="https://bhuztez.github.io/theme/css/base.css" type="text/css" />
<link rel="stylesheet" href="https://bhuztez.github.io/theme/css/math.css" type="text/css" title="math" />
<link rel="stylesheet" href="https://bhuztez.github.io/theme/css/pygments.css" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" type="text/javascript"></script>
<script type="text/javascript">
function remove_node(node){node.parentNode.removeChild(node);}
window.onload=function(){
Array.prototype.slice.call(document.querySelectorAll(".formula")).forEach(function(e){katex.render(e.getAttribute("alt"),e,{displayMode:e.tagName==="DIV"})});
remove_node(document.querySelector("link[title='math']"));
};
</script>
</head>
<body>
<header>
<nav>
<li><a href="https://bhuztez.github.io/">Home</a></li>
<li><a href="https://bhuztez.github.io/tag/how-to.html">How-tos</a></li>
<li><a href="https://bhuztez.github.io/quotes.html">Quotes</a></li>
<li><a href="https://bhuztez.github.io/archives.html">Archives</a></li>
</nav>
</header>
<div class="content">
<div>2014-03-23</div>
<article>
<h1>如何实现Prolog解释器</h1>
<div class="info">
<ul class="tags">
<li><a href="https://bhuztez.github.io/tag/prolog.html">Prolog</a></li>
</ul>
<div class="clear"></div>
</div>
<p>Prolog语言本身就不太容易理解。要理解Prolog，不如先写个简单的Prolog解释器。然而这也不那么容易，还好有<a class="reference external" href="http://wambook.sourceforge.net/">Warren's Abstract Machine: A Tutorial Reconstruction</a>。</p>
<!-- more -->
<p>WAMBOOK里把实现Prolog的过程分成L0、L1、L2、L3四个阶段。也就是把一个困难的问题，分解成了四个比较容易的问题。这样只看slides，也是能自己写出来的，未必需要先把WAMBOOK完整看一遍。值得注意的是，WAMBOOK是按C的思路来讲的，用的是可变的数据结构，回溯时会根据trail区域的内容重置对应的变量。这个还是非常繁琐的。Erlang基本数据类型都是不可变的，回溯时直接退回老版本的就可以了。差别特别大的是Unification部分，不如参考<a class="reference external" href="http://gradworks.umi.com/33/80/3380156.html">miniKanren的论文</a>。Unification以外的部分就不推荐了，因为都是用很费解的宏写的，而且现在是要实现Prolog解释器。</p>
<p>Prolog中的<code>atom</code>可以直接用Erlang中的<code>atom</code>表示，而<code>a(b,c)</code>用<code>{term, a, [b,c]}</code>表示，变量<code>X</code>用<code>{var, 'X'}</code>表示，而变量的cell，用<code>{var, 1}</code>表示，不同的整数表示不同的cell。</p>
<pre class="code erlang literal-block">
<span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">prolog</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">lookup</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="p">[])</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">K</span><span class="p">};</span>
<span class="nf">lookup</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="p">[{</span><span class="nv">K</span><span class="p">,</span><span class="nv">V</span><span class="p">}|_])</span> <span class="o">-&gt;</span>
    <span class="nv">V</span><span class="p">;</span>
<span class="nf">lookup</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="p">[_|</span><span class="nv">S</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="n">lookup</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="nv">S</span><span class="p">).</span>

<span class="nf">lookup_var</span><span class="p">(</span><span class="nv">V</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="n">lookup</span><span class="p">(</span><span class="nv">V</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">V1</span><span class="p">}</span> <span class="k">when</span> <span class="nv">V1</span> <span class="o">=/=</span> <span class="nv">V</span> <span class="o">-&gt;</span>
            <span class="n">lookup_var</span><span class="p">(</span><span class="nv">V1</span><span class="p">,</span> <span class="nv">S</span><span class="p">);</span>
        <span class="nv">Other</span> <span class="o">-&gt;</span>
            <span class="nv">Other</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">subst</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="nv">V</span><span class="p">},</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="n">lookup_var</span><span class="p">(</span><span class="nv">V</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nv">V1</span> <span class="o">-&gt;</span>
            <span class="nv">V1</span><span class="p">;</span>
        <span class="nv">Other</span> <span class="o">-&gt;</span>
            <span class="n">subst</span><span class="p">(</span><span class="nv">Other</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">subst</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">},</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">subst</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">S</span><span class="p">),</span> <span class="n">subst</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span> <span class="nv">S</span><span class="p">)};</span>
<span class="nf">subst</span><span class="p">([],</span> <span class="p">_</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[];</span>
<span class="nf">subst</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="n">subst</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span><span class="nv">S</span><span class="p">)|</span><span class="n">subst</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span><span class="nv">S</span><span class="p">)];</span>
<span class="nf">subst</span><span class="p">(</span><span class="nv">Atom</span><span class="p">,</span> <span class="p">_)</span> <span class="k">when</span> <span class="nb">is_atom</span><span class="p">(</span><span class="nv">Atom</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Atom</span><span class="p">.</span>

<span class="nf">occurs</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">V</span><span class="p">},</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="n">lookup_var</span><span class="p">(</span><span class="nv">V</span> <span class="p">,</span><span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">Y</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nv">X</span> <span class="o">=:=</span> <span class="nv">Y</span><span class="p">;</span>
        <span class="nv">Other</span> <span class="o">-&gt;</span>
            <span class="n">occurs</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Other</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">occurs</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">},</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">occurs</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="p">[</span><span class="nv">F</span><span class="p">|</span><span class="nv">A</span><span class="p">],</span> <span class="nv">S</span><span class="p">);</span>
<span class="nf">occurs</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">occurs</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">H</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="ow">or</span> <span class="n">occurs</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">T</span><span class="p">,</span> <span class="nv">S</span><span class="p">);</span>
<span class="nf">occurs</span><span class="p">(_,</span> <span class="p">_,</span> <span class="p">_)</span> <span class="o">-&gt;</span>
    <span class="n">false</span><span class="p">.</span>

<span class="nf">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="nv">V1</span><span class="p">},</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="n">lookup_var</span><span class="p">(</span><span class="nv">V1</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">X</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="k">case</span> <span class="n">occurs</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
                <span class="n">true</span> <span class="o">-&gt;</span>
                    <span class="k">case</span> <span class="nv">Y</span> <span class="k">of</span>
                        <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">V2</span><span class="p">}</span> <span class="o">-&gt;</span>
                            <span class="k">case</span> <span class="n">lookup_var</span><span class="p">(</span><span class="nv">V2</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
                                <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">X</span><span class="p">}</span> <span class="o">-&gt;</span>
                                    <span class="nv">S</span><span class="p">;</span>
                                <span class="p">_</span> <span class="o">-&gt;</span>
                                    <span class="n">false</span>
                            <span class="k">end</span><span class="p">;</span>
                        <span class="p">_</span> <span class="o">-&gt;</span>
                            <span class="n">false</span>
                    <span class="k">end</span><span class="p">;</span>
                <span class="n">false</span> <span class="o">-&gt;</span>
                    <span class="p">[{</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">}|</span><span class="nv">S</span><span class="p">]</span>
            <span class="k">end</span><span class="p">;</span>
        <span class="nv">Other</span> <span class="o">-&gt;</span>
            <span class="n">unify</span><span class="p">(</span><span class="nv">Other</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">unify</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">unify</span><span class="p">(</span><span class="nv">Y</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">S</span><span class="p">);</span>
<span class="nf">unify</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="nv">F1</span><span class="p">,</span> <span class="nv">A1</span><span class="p">},</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="nv">F2</span><span class="p">,</span> <span class="nv">A2</span><span class="p">},</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">unify</span><span class="p">([</span><span class="nv">F1</span><span class="p">|</span><span class="nv">A1</span><span class="p">],</span> <span class="p">[</span><span class="nv">F2</span><span class="p">|</span><span class="nv">A2</span><span class="p">],</span> <span class="nv">S</span><span class="p">);</span>
<span class="nf">unify</span><span class="p">([],</span> <span class="p">[],</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">S</span><span class="p">;</span>
<span class="nf">unify</span><span class="p">([</span><span class="nv">H1</span><span class="p">|</span><span class="nv">T1</span><span class="p">],</span> <span class="p">[</span><span class="nv">H2</span><span class="p">|</span><span class="nv">T2</span><span class="p">],</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="n">unify</span><span class="p">(</span><span class="nv">H1</span><span class="p">,</span> <span class="nv">H2</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
    <span class="n">false</span> <span class="o">-&gt;</span>
        <span class="n">false</span><span class="p">;</span>
    <span class="nv">S1</span> <span class="o">-&gt;</span>
        <span class="n">unify</span><span class="p">(</span><span class="nv">T1</span><span class="p">,</span> <span class="nv">T2</span><span class="p">,</span> <span class="nv">S1</span><span class="p">)</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">unify</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_atom</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">S</span><span class="p">;</span>
<span class="nf">unify</span><span class="p">(_,</span> <span class="p">_,</span> <span class="p">_)</span> <span class="o">-&gt;</span>
    <span class="n">false</span><span class="p">.</span>


<span class="nf">reify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'_'</span><span class="p">},</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{{</span><span class="n">var</span><span class="p">,</span> <span class="nv">C</span><span class="p">},</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="o">+</span><span class="mi">1</span><span class="p">};</span>
<span class="nf">reify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="nv">V</span><span class="p">},</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="n">lookup_var</span><span class="p">(</span><span class="nv">V</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">N</span><span class="p">}</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="p">{{</span><span class="n">var</span><span class="p">,</span> <span class="nv">N</span><span class="p">},</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">};</span>
        <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">V1</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="p">{{</span><span class="n">var</span><span class="p">,</span> <span class="nv">C</span><span class="p">},</span> <span class="p">[{</span><span class="nv">V1</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">C</span><span class="p">}}|</span><span class="nv">S</span><span class="p">],</span> <span class="nv">C</span><span class="o">+</span><span class="mi">1</span><span class="p">};</span>
        <span class="nv">Other</span> <span class="o">-&gt;</span>
            <span class="n">reify</span><span class="p">(</span><span class="nv">Other</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">reify</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">},</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{[</span><span class="nv">F1</span><span class="p">|</span><span class="nv">A1</span><span class="p">],</span> <span class="nv">S1</span><span class="p">,</span> <span class="nv">C1</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">([</span><span class="nv">F</span><span class="p">|</span><span class="nv">A</span><span class="p">],</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">),</span>
    <span class="p">{{</span><span class="n">term</span><span class="p">,</span> <span class="nv">F1</span><span class="p">,</span> <span class="nv">A1</span><span class="p">},</span> <span class="nv">S1</span><span class="p">,</span> <span class="nv">C1</span><span class="p">};</span>
<span class="nf">reify</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">H1</span><span class="p">,</span> <span class="nv">S1</span><span class="p">,</span> <span class="nv">C1</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">),</span>
    <span class="p">{</span><span class="nv">T1</span><span class="p">,</span> <span class="nv">S2</span><span class="p">,</span> <span class="nv">C2</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">S1</span><span class="p">,</span> <span class="nv">C1</span><span class="p">),</span>
    <span class="p">{[</span><span class="nv">H1</span><span class="p">|</span><span class="nv">T1</span><span class="p">],</span> <span class="nv">S2</span><span class="p">,</span> <span class="nv">C2</span><span class="p">};</span>
<span class="nf">reify</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">X</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">}.</span>


<span class="nf">term_to_list</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">F</span><span class="p">|</span><span class="nv">A</span><span class="p">];</span>
<span class="nf">term_to_list</span><span class="p">(</span><span class="nv">Atom</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_atom</span><span class="p">(</span><span class="nv">Atom</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">Atom</span><span class="p">].</span>

<span class="nf">pred_name</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nb">list_to_atom</span><span class="p">(</span><span class="nb">atom_to_list</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="o">++</span> <span class="s">&quot;/&quot;</span> <span class="o">++</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">A</span><span class="p">))).</span>

<span class="nf">make_db</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span>
      <span class="k">fun</span> <span class="p">({</span><span class="n">clause</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Body</span><span class="p">},</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span>
              <span class="p">[</span><span class="nv">F</span><span class="p">|</span><span class="nv">A</span><span class="p">]</span> <span class="o">=</span> <span class="n">term_to_list</span><span class="p">(</span><span class="nv">Head</span><span class="p">),</span>
              <span class="nn">dict</span><span class="p">:</span><span class="nf">append</span><span class="p">(</span>
                <span class="n">pred_name</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span><span class="nv">A</span><span class="p">),</span>
                <span class="p">{</span><span class="n">rule</span><span class="p">,</span> <span class="nb">tl</span><span class="p">(</span><span class="n">term_to_list</span><span class="p">(</span><span class="nv">Head</span><span class="p">)),</span> <span class="nv">Body</span><span class="p">},</span>
                <span class="nv">Dict</span><span class="p">)</span>
      <span class="k">end</span><span class="p">,</span>
      <span class="nn">dict</span><span class="p">:</span><span class="nf">new</span><span class="p">(),</span>
      <span class="nv">Clauses</span><span class="p">).</span>


<span class="nf">answer</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">G</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">R</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">V</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">K</span><span class="p">}}</span> <span class="p">||</span> <span class="p">{</span><span class="nv">K</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span><span class="nv">V</span><span class="p">}}</span> <span class="o">&lt;-</span> <span class="nv">S</span> <span class="p">],</span>
    <span class="nv">Answer</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">K</span><span class="p">,</span> <span class="n">subst</span><span class="p">(</span><span class="n">subst</span><span class="p">(</span><span class="nv">V</span><span class="p">,</span> <span class="nv">G</span><span class="p">),</span> <span class="nv">R</span><span class="p">)}</span> <span class="p">||</span> <span class="p">{</span><span class="nv">K</span><span class="p">,</span><span class="nv">V</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">S</span><span class="p">],</span>
    <span class="p">[</span> <span class="p">{</span><span class="nv">K</span><span class="p">,</span><span class="nv">V</span><span class="p">}</span>
      <span class="p">||</span> <span class="p">{</span><span class="nv">K</span><span class="p">,</span> <span class="nv">V</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Answer</span><span class="p">,</span>
         <span class="k">case</span> <span class="nv">V</span> <span class="k">of</span>
             <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">K</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">;</span>
             <span class="p">_</span> <span class="o">-&gt;</span> <span class="n">true</span>
         <span class="k">end</span>
    <span class="p">].</span>


<span class="c">%% l0: one fact only
</span><span class="nf">query_l0</span><span class="p">(</span><span class="nv">Query</span><span class="p">,</span> <span class="nv">Head</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">Q</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">Query</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">),</span>
    <span class="k">case</span> <span class="n">prim_l0</span><span class="p">({</span><span class="n">rule</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="p">[]},</span> <span class="nv">Q</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">C</span><span class="p">)</span> <span class="k">of</span>
        <span class="n">false</span> <span class="o">-&gt;</span>
            <span class="n">false</span><span class="p">;</span>
        <span class="nv">G</span> <span class="o">-&gt;</span>
            <span class="n">answer</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">G</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">prim_l0</span><span class="p">({</span><span class="n">rule</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="p">[]},</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">Head1</span><span class="p">,</span> <span class="p">_,</span> <span class="p">_}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">),</span>
    <span class="n">unify</span><span class="p">(</span><span class="nv">Head1</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">G</span><span class="p">).</span>


<span class="c">%% l1 -&gt; one fact per predicate
</span><span class="nf">query_l1</span><span class="p">(</span><span class="nv">Query</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">Q</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">Query</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">),</span>
    <span class="k">case</span> <span class="n">call_l1</span><span class="p">(</span><span class="nv">Q</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="k">of</span>
    <span class="n">false</span> <span class="o">-&gt;</span>
        <span class="n">false</span><span class="p">;</span>
    <span class="nv">G</span> <span class="o">-&gt;</span>
        <span class="n">answer</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">G</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">call_l1</span><span class="p">(</span><span class="nv">Term</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">F</span><span class="p">|</span><span class="nv">A</span><span class="p">]</span> <span class="o">=</span> <span class="n">term_to_list</span><span class="p">(</span><span class="nv">Term</span><span class="p">),</span>
    <span class="nv">Name</span> <span class="o">=</span> <span class="n">pred_name</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">),</span>
    <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="k">of</span>
        <span class="n">error</span> <span class="o">-&gt;</span>
            <span class="n">false</span><span class="p">;</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[</span><span class="nv">Rule</span><span class="p">]}</span> <span class="o">-&gt;</span>
            <span class="n">prim_l0</span><span class="p">(</span><span class="nv">Rule</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>


<span class="c">%% l2 -&gt; one clause per predicate
</span><span class="nf">query_l2</span><span class="p">(</span><span class="nv">Query</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="n">success_l2</span><span class="p">([{[],</span> <span class="nv">Query</span><span class="p">}],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="k">of</span>
        <span class="n">false</span> <span class="o">-&gt;</span>
            <span class="n">false</span><span class="p">;</span>
        <span class="nv">Answer</span> <span class="o">-&gt;</span>
            <span class="nv">Answer</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">success_l2</span><span class="p">([{</span><span class="nv">S</span><span class="p">,</span> <span class="p">[]}],</span> <span class="nv">G</span><span class="p">,</span> <span class="p">_</span><span class="nv">C</span><span class="p">,</span> <span class="p">_</span><span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">answer</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">G</span><span class="p">);</span>
<span class="nf">success_l2</span><span class="p">([{_,</span> <span class="p">[]}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">success_l2</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">DB</span><span class="p">);</span>
<span class="nf">success_l2</span><span class="p">([{</span><span class="nv">S</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">]}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">H1</span><span class="p">,</span> <span class="nv">S1</span><span class="p">,</span> <span class="nv">C1</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">),</span>
    <span class="n">call_l2</span><span class="p">(</span><span class="nv">H1</span><span class="p">,</span> <span class="p">[{</span><span class="nv">S1</span><span class="p">,</span><span class="nv">T</span><span class="p">}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C1</span><span class="p">,</span> <span class="nv">DB</span><span class="p">).</span>

<span class="nf">call_l2</span><span class="p">(</span><span class="nv">Term</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">F</span><span class="p">|</span><span class="nv">A</span><span class="p">]</span> <span class="o">=</span> <span class="n">term_to_list</span><span class="p">(</span><span class="nv">Term</span><span class="p">),</span>
    <span class="nv">Name</span> <span class="o">=</span> <span class="n">pred_name</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">),</span>
    <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="k">of</span>
        <span class="n">error</span> <span class="o">-&gt;</span>
            <span class="n">false</span><span class="p">;</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[</span><span class="nv">Rule</span><span class="p">]}</span> <span class="o">-&gt;</span>
            <span class="n">prim_l2</span><span class="p">(</span><span class="nv">Rule</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">prim_l2</span><span class="p">({</span><span class="n">rule</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Body</span><span class="p">},</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">Head1</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C1</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">C</span><span class="p">),</span>
    <span class="k">case</span> <span class="n">unify</span><span class="p">(</span><span class="nv">Head1</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">G</span><span class="p">)</span> <span class="k">of</span>
    <span class="n">false</span> <span class="o">-&gt;</span>
        <span class="n">false</span><span class="p">;</span>
    <span class="nv">G1</span> <span class="o">-&gt;</span>
        <span class="n">success_l2</span><span class="p">([{</span><span class="nv">S</span><span class="p">,</span> <span class="nv">Body</span><span class="p">}|</span><span class="nv">Stack</span><span class="p">],</span> <span class="nv">G1</span><span class="p">,</span> <span class="nv">C1</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>


<span class="c">%% l3 -&gt; multiple clauses per predicate
</span><span class="nf">query_l3</span><span class="p">(</span><span class="nv">Query</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="n">success_l3</span><span class="p">([{[],</span> <span class="nv">Query</span><span class="p">}],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">DB</span><span class="p">)</span> <span class="k">of</span>
        <span class="n">false</span> <span class="o">-&gt;</span>
            <span class="n">false</span><span class="p">;</span>
        <span class="p">{</span><span class="nv">Answer</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="p">{</span><span class="nv">Answer</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">}</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">success_l3</span><span class="p">([{</span><span class="nv">S</span><span class="p">,</span> <span class="p">[]}],</span> <span class="nv">G</span><span class="p">,</span> <span class="p">_</span><span class="nv">C</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">,</span> <span class="p">_</span><span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">answer</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">G</span><span class="p">),</span> <span class="nv">Cont</span><span class="p">};</span>
<span class="nf">success_l3</span><span class="p">([{_,</span> <span class="p">[]}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">success_l3</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">,</span> <span class="nv">DB</span><span class="p">);</span>
<span class="nf">success_l3</span><span class="p">([{</span><span class="nv">S</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">]}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">H1</span><span class="p">,</span> <span class="nv">S1</span><span class="p">,</span> <span class="nv">C1</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C</span><span class="p">),</span>
    <span class="n">call_l3</span><span class="p">(</span><span class="nv">H1</span><span class="p">,</span> <span class="p">[{</span><span class="nv">S1</span><span class="p">,</span><span class="nv">T</span><span class="p">}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C1</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">,</span> <span class="nv">DB</span><span class="p">).</span>

<span class="nf">call_l3</span><span class="p">(</span><span class="nv">Term</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">F</span><span class="p">|</span><span class="nv">A</span><span class="p">]</span> <span class="o">=</span> <span class="n">term_to_list</span><span class="p">(</span><span class="nv">Term</span><span class="p">),</span>
    <span class="nv">Name</span> <span class="o">=</span> <span class="n">pred_name</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">),</span>

    <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="k">of</span>
        <span class="n">error</span> <span class="o">-&gt;</span>
            <span class="nv">Choices</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Choices</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="n">ok</span>
    <span class="k">end</span><span class="p">,</span>

    <span class="n">cont_l3</span><span class="p">([{</span><span class="nv">Choices</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">}|</span><span class="nv">Cont</span><span class="p">],</span> <span class="nv">DB</span><span class="p">).</span>

<span class="nf">cont_l3</span><span class="p">([],</span> <span class="p">_)</span> <span class="o">-&gt;</span>
    <span class="n">false</span><span class="p">;</span>
<span class="nf">cont_l3</span><span class="p">([{[],</span> <span class="p">_,</span> <span class="p">_,</span> <span class="p">_,</span> <span class="p">_}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">cont_l3</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">DB</span><span class="p">);</span>
<span class="nf">cont_l3</span><span class="p">([{[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">prim_l3</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="p">[{</span><span class="nv">T</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">}|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">DB</span><span class="p">).</span>


<span class="nf">prim_l3</span><span class="p">({</span><span class="n">rule</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Body</span><span class="p">},</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">Stack</span><span class="p">,</span> <span class="nv">G</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">Head1</span><span class="p">,</span> <span class="nv">S</span><span class="p">,</span> <span class="nv">C1</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">C</span><span class="p">),</span>
    <span class="k">case</span> <span class="n">unify</span><span class="p">(</span><span class="nv">Head1</span><span class="p">,</span> <span class="nv">A</span><span class="p">,</span> <span class="nv">G</span><span class="p">)</span> <span class="k">of</span>
    <span class="n">false</span> <span class="o">-&gt;</span>
        <span class="n">cont_l3</span><span class="p">(</span><span class="nv">Cont</span><span class="p">,</span> <span class="nv">DB</span><span class="p">);</span>
    <span class="nv">G1</span> <span class="o">-&gt;</span>
        <span class="n">success_l3</span><span class="p">([{</span><span class="nv">S</span><span class="p">,</span> <span class="nv">Body</span><span class="p">}|</span><span class="nv">Stack</span><span class="p">],</span> <span class="nv">G1</span><span class="p">,</span> <span class="nv">C1</span><span class="p">,</span> <span class="nv">Cont</span><span class="p">,</span> <span class="nv">DB</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>


<span class="nf">test</span><span class="p">(</span><span class="n">lookup_var</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">X</span> <span class="o">=</span> <span class="p">{</span><span class="n">'X'</span><span class="p">,</span><span class="n">a</span><span class="p">},</span>
    <span class="nv">Y</span> <span class="o">=</span> <span class="p">{</span><span class="n">'Y'</span><span class="p">,{</span><span class="n">var</span><span class="p">,</span><span class="n">'X'</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}</span> <span class="o">=</span> <span class="n">lookup_var</span><span class="p">(</span><span class="n">'X'</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}</span> <span class="o">=</span> <span class="n">lookup_var</span><span class="p">(</span><span class="n">'X'</span><span class="p">,</span> <span class="p">[</span><span class="nv">Y</span><span class="p">]),</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">lookup_var</span><span class="p">(</span><span class="n">'X'</span><span class="p">,</span> <span class="p">[</span><span class="nv">X</span><span class="p">]),</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">lookup_var</span><span class="p">(</span><span class="n">'Y'</span><span class="p">,</span> <span class="p">[</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">]),</span>
    <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}</span> <span class="o">=</span> <span class="n">lookup_var</span><span class="p">(</span><span class="n">'Y'</span><span class="p">,</span> <span class="p">[</span><span class="nv">Y</span><span class="p">]),</span>
    <span class="n">ok</span><span class="p">;</span>
<span class="nf">test</span><span class="p">(</span><span class="n">occurs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">false</span> <span class="o">=</span> <span class="n">occurs</span><span class="p">(</span><span class="n">'X'</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="n">true</span> <span class="o">=</span> <span class="n">occurs</span><span class="p">(</span><span class="n">'X'</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[]),</span>
    <span class="nv">S</span> <span class="o">=</span> <span class="p">[{</span><span class="n">'X'</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}}],</span>
    <span class="n">false</span> <span class="o">=</span> <span class="n">occurs</span><span class="p">(</span><span class="n">'Y'</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[]),</span>
    <span class="n">true</span> <span class="o">=</span> <span class="n">occurs</span><span class="p">(</span><span class="n">'Y'</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="nv">S</span><span class="p">),</span>
    <span class="n">false</span> <span class="o">=</span> <span class="n">occurs</span><span class="p">(</span><span class="n">'Y'</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[]},</span> <span class="p">[]),</span>
    <span class="n">true</span> <span class="o">=</span> <span class="n">occurs</span><span class="p">(</span><span class="n">'Y'</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[]},</span> <span class="nv">S</span><span class="p">),</span>
    <span class="n">false</span> <span class="o">=</span> <span class="n">occurs</span><span class="p">(</span><span class="n">'Y'</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}]},</span> <span class="p">[]),</span>
    <span class="n">true</span> <span class="o">=</span> <span class="n">occurs</span><span class="p">(</span><span class="n">'Y'</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}]},</span> <span class="nv">S</span><span class="p">),</span>
    <span class="n">ok</span><span class="p">;</span>
<span class="nf">test</span><span class="p">(</span><span class="n">unify</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">false</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">[]</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]),</span>

    <span class="nv">S</span> <span class="o">=</span> <span class="p">[{</span><span class="n">'X'</span><span class="p">,</span><span class="n">a</span><span class="p">}],</span>
    <span class="nv">S</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="n">a</span><span class="p">,</span> <span class="nv">S</span><span class="p">),</span>
    <span class="n">false</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="n">b</span><span class="p">,</span> <span class="nv">S</span><span class="p">),</span>
    <span class="nv">S</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="nv">S</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[]),</span>

    <span class="nv">S</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[]},</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]},</span> <span class="p">[]),</span>
    <span class="nv">S</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[]},</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]},</span> <span class="nv">S</span><span class="p">),</span>
    <span class="nv">S</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}]},</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">]},</span> <span class="p">[]),</span>
    <span class="nv">S</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}]},</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">]},</span> <span class="nv">S</span><span class="p">),</span>

    <span class="nv">S1</span> <span class="o">=</span> <span class="p">[{</span><span class="n">'X'</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}}],</span>
    <span class="nv">S1</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">},</span> <span class="p">[]),</span>
    <span class="nv">S1</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="nv">S1</span><span class="p">),</span>
    <span class="nv">S1</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">},</span> <span class="nv">S1</span><span class="p">),</span>

    <span class="nv">S2</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">},</span> <span class="nv">S</span><span class="p">),</span>
    <span class="nv">S2</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">},</span> <span class="n">a</span><span class="p">,</span> <span class="nv">S2</span><span class="p">),</span>

    <span class="nv">S3</span> <span class="o">=</span> <span class="p">[{</span><span class="n">'Y'</span><span class="p">,</span> <span class="n">b</span><span class="p">}|</span><span class="nv">S</span><span class="p">],</span>
    <span class="nv">S3</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[</span><span class="n">b</span><span class="p">]},</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]},</span> <span class="p">[]),</span>
    <span class="nv">S3</span> <span class="o">=</span> <span class="n">unify</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[</span><span class="n">b</span><span class="p">]},</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]},</span> <span class="nv">S3</span><span class="p">),</span>
    <span class="n">ok</span><span class="p">;</span>
<span class="nf">test</span><span class="p">(</span><span class="n">subst</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">S</span> <span class="o">=</span> <span class="p">[{</span><span class="n">'X'</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">},</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Z'</span><span class="p">}]}},</span>
         <span class="p">{</span><span class="n">'Y'</span><span class="p">,</span> <span class="n">a</span><span class="p">},</span>
         <span class="p">{</span><span class="n">'Z'</span><span class="p">,</span> <span class="n">b</span><span class="p">}],</span>
    <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">},</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Z'</span><span class="p">}]}</span> <span class="o">=</span> <span class="n">lookup_var</span><span class="p">(</span><span class="n">'X'</span><span class="p">,</span> <span class="nv">S</span><span class="p">),</span>
    <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">]}</span> <span class="o">=</span> <span class="n">subst</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="nv">S</span><span class="p">),</span>
    <span class="n">ok</span><span class="p">;</span>
<span class="nf">test</span><span class="p">(</span><span class="n">reify</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{_,</span> <span class="p">[{</span><span class="n">'X'</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">}}],</span> <span class="mi">1</span><span class="p">}</span> <span class="o">=</span> <span class="n">reify</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">ok</span><span class="p">;</span>
<span class="nf">test</span><span class="p">(</span><span class="n">l0</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="n">'Y'</span><span class="p">,</span><span class="n">c</span><span class="p">},</span> <span class="p">{</span><span class="n">'X'</span><span class="p">,</span><span class="n">b</span><span class="p">}]</span> <span class="o">=</span>
        <span class="n">query_l0</span><span class="p">(</span>
          <span class="c">%% a(X,Y).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]},</span>
          <span class="c">%% a(b,c).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]}),</span>

    <span class="p">[{</span><span class="n">'X'</span><span class="p">,{</span><span class="n">var</span><span class="p">,</span><span class="n">'Y'</span><span class="p">}}]</span> <span class="o">=</span>
        <span class="n">query_l0</span><span class="p">(</span>
          <span class="c">%% a(X,Y).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]},</span>
          <span class="c">%% a(X,Y).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}]}),</span>

    <span class="p">[]</span> <span class="o">=</span>
        <span class="n">query_l0</span><span class="p">(</span>
          <span class="c">%% a(X,Y).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]},</span>
          <span class="c">%% a(_,_).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'_'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'_'</span><span class="p">}]}),</span>

    <span class="n">false</span> <span class="o">=</span>
        <span class="n">query_l0</span><span class="p">(</span>
          <span class="c">%% b(c,d).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">]},</span>
          <span class="c">%% a(b,c).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]}),</span>

    <span class="p">[]</span> <span class="o">=</span>
        <span class="n">query_l0</span><span class="p">(</span>
          <span class="c">%% a.
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]},</span>
          <span class="c">%% a.
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]}),</span>

    <span class="n">ok</span><span class="p">;</span>
<span class="nf">test</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">DB</span> <span class="o">=</span>
        <span class="n">make_db</span><span class="p">(</span>
          <span class="c">%% a. b.
</span>          <span class="p">[</span> <span class="p">{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]},</span> <span class="p">[]},</span>
            <span class="p">{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[]},</span> <span class="p">[]}</span>
          <span class="p">]</span>
         <span class="p">),</span>

    <span class="c">%% b.
</span>    <span class="p">[]</span> <span class="o">=</span> <span class="n">query_l1</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[]},</span> <span class="nv">DB</span><span class="p">),</span>
    <span class="c">%% c.
</span>    <span class="n">false</span> <span class="o">=</span> <span class="n">query_l1</span><span class="p">({</span><span class="n">term</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">[]},</span> <span class="nv">DB</span><span class="p">),</span>

    <span class="p">[{</span><span class="n">'Y'</span><span class="p">,</span><span class="n">c</span><span class="p">},{</span><span class="n">'X'</span><span class="p">,</span><span class="n">b</span><span class="p">}]</span> <span class="o">=</span>
        <span class="n">query_l1</span><span class="p">(</span>
          <span class="c">%% a(X,Y).
</span>          <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]},</span>
          <span class="c">%% a(b,c).
</span>          <span class="n">make_db</span><span class="p">([{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]},</span> <span class="p">[]}])),</span>
    <span class="n">ok</span><span class="p">;</span>
<span class="nf">test</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="c">%% a.
</span>    <span class="n">false</span> <span class="o">=</span> <span class="n">query_l2</span><span class="p">([{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[]}],</span> <span class="n">make_db</span><span class="p">([])),</span>

    <span class="p">[{</span><span class="n">'Y'</span><span class="p">,</span><span class="n">a</span><span class="p">},{</span><span class="n">'X'</span><span class="p">,</span><span class="n">b</span><span class="p">}]</span> <span class="o">=</span>
        <span class="n">query_l2</span><span class="p">(</span>
          <span class="c">%% a(X), b(Y).
</span>          <span class="p">[{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}]},</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]}],</span>
          <span class="n">make_db</span><span class="p">(</span>
            <span class="c">%% a(b). b(a).
</span>            <span class="p">[{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">]},</span> <span class="p">[]},</span>
             <span class="p">{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">]},</span> <span class="p">[]}</span>
            <span class="p">])</span>
         <span class="p">),</span>

    <span class="p">[{</span><span class="n">'Y'</span><span class="p">,</span><span class="n">b</span><span class="p">},{</span><span class="n">'X'</span><span class="p">,</span><span class="n">a</span><span class="p">}]</span> <span class="o">=</span>
        <span class="n">query_l2</span><span class="p">(</span>
          <span class="c">%% a(X,Y).
</span>          <span class="p">[{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]}],</span>
          <span class="n">make_db</span><span class="p">(</span>
            <span class="c">%% a(X,b) :- b(X).
</span>            <span class="c">%% b(a).
</span>            <span class="p">[{</span><span class="n">clause</span><span class="p">,</span>
              <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="n">b</span><span class="p">]},</span>
              <span class="p">[{</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}]}]},</span>
             <span class="p">{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">]},</span> <span class="p">[]}</span>
            <span class="p">])</span>
         <span class="p">),</span>

    <span class="n">ok</span><span class="p">;</span>
<span class="nf">test</span><span class="p">(</span><span class="n">l3</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">DB1</span> <span class="o">=</span>
        <span class="n">make_db</span><span class="p">(</span>
          <span class="c">%% a(b,b). a(a,b). b(a).
</span>          <span class="p">[{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]},</span> <span class="p">[]},</span>
           <span class="p">{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]},</span> <span class="p">[]},</span>
           <span class="p">{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">]},</span> <span class="p">[]}</span>
          <span class="p">]),</span>
    <span class="p">{[{</span><span class="n">'Y'</span><span class="p">,</span><span class="n">b</span><span class="p">},{</span><span class="n">'X'</span><span class="p">,</span><span class="n">a</span><span class="p">}],</span> <span class="nv">Cont1</span><span class="p">}</span> <span class="o">=</span>
        <span class="n">query_l3</span><span class="p">(</span>
          <span class="c">%% a(X,Y), b(X).
</span>          <span class="p">[{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]},</span>
           <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">}]}],</span>
          <span class="nv">DB1</span><span class="p">),</span>
    <span class="n">false</span> <span class="o">=</span> <span class="n">cont_l3</span><span class="p">(</span><span class="nv">Cont1</span><span class="p">,</span> <span class="nv">DB1</span><span class="p">),</span>

    <span class="nv">DB2</span> <span class="o">=</span>
        <span class="n">make_db</span><span class="p">(</span>
          <span class="c">%% a(a,b). a(a,b). a(a,b).
</span>          <span class="p">[{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]},</span> <span class="p">[]},</span>
           <span class="p">{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]},</span> <span class="p">[]},</span>
           <span class="p">{</span><span class="n">clause</span><span class="p">,</span> <span class="p">{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]},</span> <span class="p">[]}</span>
          <span class="p">]),</span>
    <span class="p">{[{</span><span class="n">'Y'</span><span class="p">,</span><span class="n">b</span><span class="p">},{</span><span class="n">'X'</span><span class="p">,</span><span class="n">a</span><span class="p">}],</span> <span class="nv">Cont2</span><span class="p">}</span> <span class="o">=</span>
        <span class="n">query_l3</span><span class="p">(</span>
          <span class="c">%% a(X,Y)
</span>          <span class="p">[{</span><span class="n">term</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[{</span><span class="n">var</span><span class="p">,</span> <span class="n">'X'</span><span class="p">},</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="n">'Y'</span><span class="p">}]}],</span>
          <span class="nv">DB2</span><span class="p">),</span>
    <span class="p">{[{</span><span class="n">'Y'</span><span class="p">,</span><span class="n">b</span><span class="p">},{</span><span class="n">'X'</span><span class="p">,</span><span class="n">a</span><span class="p">}],</span> <span class="nv">Cont3</span><span class="p">}</span> <span class="o">=</span> <span class="n">cont_l3</span><span class="p">(</span><span class="nv">Cont2</span><span class="p">,</span> <span class="nv">DB2</span><span class="p">),</span>
    <span class="p">{[{</span><span class="n">'Y'</span><span class="p">,</span><span class="n">b</span><span class="p">},{</span><span class="n">'X'</span><span class="p">,</span><span class="n">a</span><span class="p">}],</span> <span class="nv">Cont4</span><span class="p">}</span> <span class="o">=</span> <span class="n">cont_l3</span><span class="p">(</span><span class="nv">Cont3</span><span class="p">,</span> <span class="nv">DB2</span><span class="p">),</span>
    <span class="n">false</span> <span class="o">=</span> <span class="n">cont_l3</span><span class="p">(</span><span class="nv">Cont4</span><span class="p">,</span> <span class="nv">DB2</span><span class="p">),</span>
    <span class="n">ok</span><span class="p">.</span>


<span class="nf">test</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="n">test</span><span class="p">(</span><span class="n">lookup_var</span><span class="p">),</span>
    <span class="n">test</span><span class="p">(</span><span class="n">occurs</span><span class="p">),</span>
    <span class="n">test</span><span class="p">(</span><span class="n">unify</span><span class="p">),</span>
    <span class="n">test</span><span class="p">(</span><span class="n">subst</span><span class="p">),</span>
    <span class="n">test</span><span class="p">(</span><span class="n">reify</span><span class="p">),</span>
    <span class="n">test</span><span class="p">(</span><span class="n">l0</span><span class="p">),</span>
    <span class="n">test</span><span class="p">(</span><span class="n">l1</span><span class="p">),</span>
    <span class="n">test</span><span class="p">(</span><span class="n">l2</span><span class="p">),</span>
    <span class="n">test</span><span class="p">(</span><span class="n">l3</span><span class="p">),</span>
    <span class="n">ok</span><span class="p">.</span>
</pre>

</article>
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'bhuztez-github-io';
(function() {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>
</body>
</html>